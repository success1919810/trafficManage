import { router } from '@kit.ArkUI';
interface AbnormalDutyRecord {
  id: string;
  name: string;
  department: string;
  supervisionResult: string;
  abnormalType: string;
  abnormalDate: string;
  status: 'pending' | 'feedback'| 'confirm' | 'completed';
}

@Entry
@Component
struct AbnormalDutyApproval {
  @State currentTab: number = 0; // 0-å¾…å®¡æ ¸, 1-å¾…åé¦ˆ, 2-å¾…åé¦ˆ, 3-å·²å®Œæˆ
  @State searchText: string = '';
  @State text1: string = "æœˆä»½";
  @State text2: string = "é€‰æ‹©éƒ¨é—¨";
  @State index: number = 2;
  @State space: number = 8;
  @State arrowPosition: ArrowPosition = ArrowPosition.END;
  @State selectAllChecked: boolean = false;
  @State checkedItems: Set<string> = new Set();

  private abnormalRecords: AbnormalDutyRecord[] = [
    {
      id: '1',
      name: 'å¼ é£é£',
      department: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸€å¤§é˜Ÿ',
      supervisionResult: 'å¼‚å¸¸',
      abnormalType: 'è„±å²—',
      abnormalDate: '2021-4-11',
      status: 'pending'
    },
    {
      id: '2',
      name: 'å¼ äºšé£',
      department: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸€å¤§é˜Ÿ',
      supervisionResult: 'å¼‚å¸¸',
      abnormalType: 'è„±å²—',
      abnormalDate: '2021-4-11',
      status: 'feedback'
    },
    {
      id: '3',
      name: 'å¼ äºšé£',
      department: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸€å¤§é˜Ÿ',
      supervisionResult: 'å¼‚å¸¸',
      abnormalType: 'è„±å²—',
      abnormalDate: '2021-4-11',
      status: 'confirm'
    },
    {
      id: '4',
      name: 'å¼ äºšé£',
      department: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸€å¤§é˜Ÿ',
      supervisionResult: 'å¼‚å¸¸',
      abnormalType: 'è„±å²—',
      abnormalDate: '2021-4-11',
      status: 'completed'
    }
  ];

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row(){
        Text('<')
          .fontSize(40)
          .margin({bottom:30})
          .width('10%')
          .onClick(() => {
            router.back();
          })

        Text('å¼‚å¸¸å‹¤åŠ¡å®¡æ‰¹')
          .fontSize(20)
          .margin({ bottom: 0 })
          .textAlign(TextAlign.Center)
          .width('80%')

        Text('<')
          .fontSize(26)
          .fontColor('#F2F2F2')
          .margin({bottom:20})
          .width('10%')
      }.backgroundColor('#F2F2F2').width('100%').height(50).margin({ top: 40 });

      //ç­›é€‰å™¨åŒºåŸŸ
      Row() {
        // æœˆä»½é€‰æ‹©
        Row() {
          Select([{ value: 'ä¸€æœˆ' }, { value: 'äºŒæœˆ' },{ value: 'ä¸‰æœˆ' },{ value: 'å››æœˆ' },{ value: 'äº”æœˆ' },{ value: 'å…­æœˆ' },{ value: 'ä¸ƒæœˆ' },{ value: 'å…«æœˆ' },{ value: 'ä¹æœˆ' },{ value: 'åæœˆ' },{ value: 'åä¸€æœˆ' },{ value: 'åäºŒæœˆ' }])
            .selected(this.index)
            .value(this.text1)
            .font({ size: 16, weight: 500 })
            .fontColor('#182431')
            .selectedOptionFont({ size: 16, weight: 400 })
            .optionFont({ size: 16, weight: 400 })
            .space(this.space)
            .arrowPosition(this.arrowPosition)
            .menuAlign(MenuAlignType.START, { dx: 0, dy: 0 })
            .optionWidth(120)
            .optionHeight(300)
            .onSelect((index: number, text?: string | undefined) => {
              console.info('Select:' + index);
              this.index = index;
              if (text) {
                this.text1 = text;
              }
            })
        }

        // éƒ¨é—¨é€‰æ‹©
        Row() {
          Select([{ value: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸€å¤§é˜Ÿ' }, { value: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜ŸäºŒå¤§é˜Ÿ' },{ value: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿä¸‰å¤§é˜Ÿ' },{ value: 'å†…æ±Ÿå¸‚äº¤è­¦æ”¯é˜Ÿå››å¤§é˜Ÿ' }])
            .selected(this.index)
            .value(this.text2)
            .font({ size: 16, weight: 500 })
            .fontColor('#182431')
            .selectedOptionFont({ size: 16, weight: 400 })
            .optionFont({ size: 16, weight: 400 })
            .space(this.space)
            .arrowPosition(this.arrowPosition)
            .menuAlign(MenuAlignType.START, { dx: 0, dy: 0 })
            .optionWidth(120)
            .optionHeight(300)
            .onSelect((index: number, text?: string | undefined) => {
              console.info('Select:' + index);
              this.index = index;
              if (text) {
                this.text2 = text;
              }
            })
        }

        Blank()

        // æœç´¢æ¡†
        Row() {
          Text('ğŸ”')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ right: 8 })

          Text('è¾“å…¥äººå‘˜å§“åè¿›è¡Œæœç´¢')
            .fontSize(14)
            .fontColor('#CCCCCC')
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor('#FFFFFF')
        .borderRadius(4)
        .width('100%')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
      .backgroundColor('#F5F5F5')

      // çŠ¶æ€æ ‡ç­¾
      Row() {
        this.buildTabItem('å¾…å®¡æ ¸', 0, 1)
        this.buildTabItem('å¾…åé¦ˆ', 1, 2)
        this.buildTabItem('å¾…åé¦ˆ', 2, 0)
        this.buildTabItem('å·²å®Œæˆ', 3, 0)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.SpaceAround)

      //è®°å½•åˆ—è¡¨
      List() {
        ForEach(this.getFilteredRecords(), (record: AbnormalDutyRecord) => {
          ListItem() {
            this.buildRecordCard(record)
          }
          .margin({ bottom: 12 })
        })

        // å…¨é€‰å’Œæ‰¹é‡å®¡æ ¸
        if (this.currentTab === 0) {
          ListItem() {
            Row() {
              Row() {
                Checkbox({ name: 'selectAll', group: 'checkboxGroup' })
                  .select(this.selectAllChecked)
                  .onChange((value: boolean) => {
                    this.selectAllChecked = value;
                  })

                Text('å…¨é€‰')
                  .fontSize(16)
                  .margin({ left: 8 })

                Text(`å…±${this.getFilteredRecords().length}æ¡å¼‚å¸¸å‹¤åŠ¡è®°å½•`)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ left: 16 })
              }

              Blank()

              Button('å®¡æ ¸')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor('#007AFF')
                .borderRadius(4)
                .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ShenPiGuanLi/abnormalServiceApproval'
                  });
                })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')

  }

  @Builder
  buildTabItem(title: string, tabIndex: number, badgeCount: number) {
    Column() {
      Stack() {
        Text(title)
          .fontSize(16)
          .fontColor(this.currentTab === tabIndex ? '#007AFF' : '#999999')
          .fontWeight(this.currentTab === tabIndex ? FontWeight.Medium : FontWeight.Normal)

        if (badgeCount > 0) {
          Text(badgeCount.toString())
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF3B30')
            .borderRadius(8)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .position({ x: 20, y: -8 })
        }
      }
    }
    .onClick(() => {
      this.currentTab = tabIndex;
    })
  }

  @Builder
  buildRecordCard(record: AbnormalDutyRecord) {
    Column() {
      Row() {
        if (this.currentTab === 0) {
          Checkbox({ name: record.id, group: 'checkboxGroup' })
            .select(this.checkedItems.has(record.id))
            .onChange((value: boolean) => {
              if (value) {
                this.checkedItems.add(record.id);
              } else {
                this.checkedItems.delete(record.id);
              }
            })
            .margin({ right: 12 })
        }

        Column() {
          Row() {
            Text(record.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')

            Blank()

            if (record.status === 'pending') {
              Button('å®¡æ ¸')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor('#007AFF')
                .borderRadius(4)
                .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ShenPiGuanLi/abnormalServiceApproval'
                  });
                })
            } else if (record.status === 'feedback') {
              Button('åé¦ˆ')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor('#007AFF')
                .borderRadius(4)
                .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ShenPiGuanLi/abnormalServiceFeedBack'
                  });
                })
            } else if (record.status === 'confirm') {
              Button('ç¡®è®¤')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor('#007AFF')
                .borderRadius(4)
                .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ShenPiGuanLi/abnormalServiceConfirm'
                  });
                })
            }else {
              Text('>')
                .fontSize(20)
                .fontColor('#CCCCCC')
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ShenPiGuanLi/abnormalServiceDetail'
                  });
                })
            }
          }
          .width('100%')
          .margin({ bottom: 12 })

          Column({ space: 8 }) {
            Row() {
              Text('æ‰€å±éƒ¨é—¨ï¼š')
                .fontSize(14)
                .fontColor('#333333')
                .width(80)

              Text(record.department)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)

            Row() {
              Text('ç›‘ç£ç»“æœï¼š')
                .fontSize(14)
                .fontColor('#333333')
                .width(80)

              Text(record.supervisionResult)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)

            Row() {
              Text('å¼‚å¸¸ç±»å‹ï¼š')
                .fontSize(14)
                .fontColor('#333333')
                .width(80)

              Text(record.abnormalType)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)

            Row() {
              Text('å¼‚å¸¸æ—¥æœŸï¼š')
                .fontSize(14)
                .fontColor('#333333')
                .width(80)

              Text(record.abnormalDate)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
          }
        }
        .layoutWeight(1)
      }
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({ radius: 2, color: '#00000010', offsetY: 1 })
  }

  getFilteredRecords(): AbnormalDutyRecord[] {
    return this.abnormalRecords.filter(record => {
      if (this.currentTab === 0) return record.status === 'pending';
      if (this.currentTab === 1) return record.status === 'feedback';
      if (this.currentTab === 2) return record.status === 'confirm';
      if (this.currentTab === 3) return record.status === 'completed';
      return true;
    });
  }
}